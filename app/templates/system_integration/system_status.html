<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Cross-Domain Predictive Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .alert-item {
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }
        .alert-item.critical {
            border-left-color: #dc3545;
        }
        .alert-item.warning {
            border-left-color: #ffc107;
        }
        .alert-item.info {
            border-left-color: #0dcaf0;
        }
        .real-time-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Cross-Domain Predictive Analytics</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/system/system-status">System Status</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4" id="status-panel">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">System Status Overview</h5>
        </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">System Status</h6>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <div class="spinner-grow text-success me-2" role="status" style="width: 1rem; height: 1rem;"></div>
                                            <h4 id="system-status" class="mb-0">Active</h4>
                            </div>
                        </div>
                    </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Uptime</h6>
                                        <h4 id="system-uptime">00:00:00</h4>
                </div>
            </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Processing Rate</h6>
                                        <h4 id="processing-rate">0.00/s</h4>
                        </div>
                    </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card mb-3">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted">Queue Size</h6>
                                        <h4 id="queue-size">0</h4>
                </div>
            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Active Components</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover" id="components-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th>Status</th>
                                    <th>Health</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>API Connectors</td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td><div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 98%;" aria-valuenow="98" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div></td>
                                </tr>
                                <tr>
                                    <td>ML Models</td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td><div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 87%;" aria-valuenow="87" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div></td>
                                </tr>
                                <tr>
                                    <td>Visualization</td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td><div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 95%;" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div></td>
                                </tr>
                                <tr>
                                    <td>System Integration</td>
                                    <td><span class="badge bg-success">Active</span></td>
                                    <td><div class="progress" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 90%;" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">System Events</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="system-events">
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">System startup complete</h6>
                                    <small>Just now</small>
                                </div>
                                <p class="mb-1">All system components initialized successfully</p>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">Data pipeline activated</h6>
                                    <small>Just now</small>
                                </div>
                                <p class="mb-1">Real-time data processing has been activated</p>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">ML models loaded</h6>
                                    <small>Just now</small>
                                </div>
                                <p class="mb-1">Machine learning models loaded successfully</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Usage Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-3"><i class="bi bi-hdd-network me-2"></i>API Requests</h6>
                                        <canvas id="api-requests-chart" height="200"></canvas>
                                        <div class="text-center mt-3">
                                            <span class="badge bg-info">Average: <span id="api-avg">42</span>/hr</span>
                                            <span class="badge bg-success ms-2">Peak: <span id="api-peak">78</span>/hr</span>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            <div class="col-md-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-3"><i class="bi bi-lightning-charge me-2"></i>Prediction Requests</h6>
                                        <canvas id="prediction-requests-chart" height="200"></canvas>
                                        <div class="text-center mt-3">
                                            <span class="badge bg-info">Average: <span id="pred-avg">24</span>/hr</span>
                                            <span class="badge bg-success ms-2">Peak: <span id="pred-peak">56</span>/hr</span>
                                        </div>
                                    </div>
                                </div>
                                </div>
                            <div class="col-md-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted mb-3"><i class="bi bi-people me-2"></i>User Sessions</h6>
                                        <canvas id="user-sessions-chart" height="200"></canvas>
                                        <div class="text-center mt-3">
                                            <span class="badge bg-info">Average: <span id="session-avg">18</span>/hr</span>
                                            <span class="badge bg-success ms-2">Peak: <span id="session-peak">32</span>/hr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Check if Chart.js is loaded
        const isChartJsLoaded = typeof Chart !== 'undefined';
        if (!isChartJsLoaded) {
            console.error('Chart.js is not loaded. Charts will not be rendered.');
        
            // Add a fallback script tag to try loading Chart.js again
            const chartScript = document.createElement('script');
            chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
            chartScript.onload = function() {
                console.log('Chart.js loaded successfully via fallback');
                createCharts();
            };
            chartScript.onerror = function() {
                console.error('Failed to load Chart.js even with fallback');
                
                // Replace chart containers with error messages
                document.querySelectorAll('[id$="-chart"]').forEach(container => {
                    container.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Chart rendering not available
                    </div>
                `;
                });
            };
            document.head.appendChild(chartScript);
        }
        
        // System status elements
        const systemStatusElement = document.getElementById('system-status');
        const systemUptimeElement = document.getElementById('system-uptime');
        const processingRateElement = document.getElementById('processing-rate');
        const queueSizeElement = document.getElementById('queue-size');
        
        // Initial fetch of system status
        async function loadSystemStatus() {
            try {
                // Use the correct API endpoint with the /system prefix
                const response = await fetch('/system/api/system-status');
                if (!response.ok) {
                    throw new Error(`System status API returned ${response.status}`);
                }

                const data = await response.json();
                console.log('System status data:', data);

                // Update the dashboard with the data
                updateSystemStatus(data);

                // Also update the charts with new system data
                updateCharts();
            } catch (error) {
                console.error('Error loading system status:', error);
                // Use fallback data
                updateSystemStatus({
                    status: 'active',
                    uptime: 3600, // 1 hour
                    processing_rate: 42.5,
                    queue_size: 12,
                    components: {
                        api_connectors: {
                            status: 'active',
                            connections: 4,
                            error_rate: 0.02
                        },
                        ml_models: {
                            status: 'active',
                            models_loaded: 3,
                            prediction_accuracy: 0.87
                        },
                        visualization: {
                            status: 'active',
                            active_visualizations: 8
                        }
                    }
                });
            }
        }
        
        // Execute on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSystemStatus();
        
            // Only create charts if Chart.js is available
            if (isChartJsLoaded) {
                createCharts();
            }
        });

        function updateSystemStatus(data) {
            try {
                if (!data) {
                    console.error('No data provided to updateSystemStatus');
                    data = {
                        status: 'unknown',
                        uptime: 0,
                        processing_rate: 0,
                        queue_size: 0
                    };
                }
                
                // Update status indicator
                if (systemStatusElement) {
                    systemStatusElement.innerText = data.status || 'Unknown';
                    
                    // Update status indicator color based on status
                    const statusIndicator = document.querySelector('.spinner-grow');
                    if (statusIndicator) {
                        // Remove all existing classes
                        statusIndicator.classList.remove('text-success', 'text-warning', 'text-danger');
                        
                        // Add appropriate class based on status
                        if (data.status === 'active') {
                            statusIndicator.classList.add('text-success');
                        } else if (data.status === 'warning' || data.status === 'degraded') {
                            statusIndicator.classList.add('text-warning');
                        } else if (data.status === 'inactive' || data.status === 'error') {
                            statusIndicator.classList.add('text-danger');
                        } else {
                            statusIndicator.classList.add('text-secondary');
                        }
                    }
                }
                
                // Format uptime as hh:mm:ss
                if (systemUptimeElement) {
                    const uptime = data.uptime || 0;
                    const hours = Math.floor(uptime / 3600);
                    const minutes = Math.floor((uptime % 3600) / 60);
                    const seconds = Math.floor(uptime % 60);
                    systemUptimeElement.innerText = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Update processing rate and queue size
                if (processingRateElement) {
                    processingRateElement.innerText = `${(data.processing_rate || 0).toFixed(2)}/s`;
                }
                
                if (queueSizeElement) {
                    queueSizeElement.innerText = data.queue_size || 0;
                }
                
                // Update components table if we have component data
                if (data.components) {
                    const tableBody = document.querySelector('#components-table tbody');
                    if (tableBody) {
                        tableBody.innerHTML = ''; // Clear existing rows
                        
                        // Add a row for each component
                        for (const [name, info] of Object.entries(data.components)) {
                            const row = document.createElement('tr');
                            
                            // Format component name
                            const displayName = name.replace(/_/g, ' ')
                                .split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ');
                            
                            // Calculate health based on available metrics
                            let health = 90; // Default health
                            if (info.error_rate !== undefined) {
                                health = Math.max(0, Math.min(100, 100 - (info.error_rate * 100)));
                            } else if (info.prediction_accuracy !== undefined) {
                                health = Math.max(0, Math.min(100, info.prediction_accuracy * 100));
                            }
                            
                            // Determine badge class based on status
                            const badgeClass = info.status === 'active' ? 'bg-success' : 
                                            info.status === 'warning' ? 'bg-warning' : 
                                            info.status === 'error' ? 'bg-danger' : 'bg-secondary';
                            
                            // Determine progress bar class based on health
                            const progressClass = health > 80 ? 'bg-success' : 
                                                health > 60 ? 'bg-info' :
                                                health > 40 ? 'bg-warning' : 'bg-danger';
                            
                            row.innerHTML = `
                                <td>${displayName}</td>
                                <td><span class="badge ${badgeClass}">${info.status || 'unknown'}</span></td>
                                <td><div class="progress" style="height: 5px;">
                                    <div class="progress-bar ${progressClass}" role="progressbar" 
                                        style="width: ${health}%;" aria-valuenow="${health}" 
                                        aria-valuemin="0" aria-valuemax="100"></div>
                                </div></td>
                            `;
                            
                            tableBody.appendChild(row);
                }
                    }
        }
        
                // Update events list with a new event
                const eventsContainer = document.getElementById('system-events');
                if (eventsContainer) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    
                    const eventHTML = `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">System status updated</h6>
                                <small>${timeString}</small>
                            </div>
                            <p class="mb-1">System is ${data.status || 'online'} with ${data.components ? Object.keys(data.components).length : 0} active components</p>
                        </div>
                    `;
                    
                    // Add new event at the top
                    eventsContainer.innerHTML = eventHTML + eventsContainer.innerHTML;
                    
                    // Keep only the last 5 events
                    const events = eventsContainer.querySelectorAll('.list-group-item');
                    if (events.length > 5) {
                        for (let i = 5; i < events.length; i++) {
                            events[i].remove();
                }
                    }
                }
                
                // Update charts with new data if available
                if (data.chart_data) {
                    updateCharts(data.chart_data);
                }
            } catch (error) {
                console.error('Error updating system status UI:', error);
            }
        }

        // Charts for the visualization
        let apiRequestsChart, predictionRequestsChart, userSessionsChart;
        
        function createCharts() {
            // Create charts with realistic data patterns
            apiRequestsChart = createChart(
                'api-requests-chart', 
                'API Requests', 
                '#0dcaf0', 
                generateRealisticData(40, 80, 24),
                ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', 
                 '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00']
            );
            
            predictionRequestsChart = createChart(
                'prediction-requests-chart', 
                'Prediction Requests', 
                '#6f42c1', 
                generateRealisticData(20, 60, 24, 0.7),
                ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', 
                 '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00']
            );
            
            userSessionsChart = createChart(
                'user-sessions-chart', 
                'User Sessions', 
                '#20c997', 
                generateRealisticData(15, 35, 24, 0.5),
                ['00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00', '10:00', '11:00', 
                 '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00']
            );
            
            // Update summary statistics
            updateChartStatistics();
        }
        
        function generateRealisticData(baseline, max, points, correlation = 0.8) {
            const data = [];
            let value = baseline + (Math.random() * 10);
            
            // Create a business-hours pattern (higher during work hours)
            for (let i = 0; i < points; i++) {
                // Business hours pattern (hours 8-18 have higher values)
                let hourFactor = 1;
                if (i >= 8 && i <= 18) {
                    hourFactor = 1.5; // 50% increase during business hours
                }
                
                // Some randomness, but with correlation to previous value
                const randomChange = (Math.random() * 20 - 10);
                const correlatedChange = correlation * (value - baseline) + (1 - correlation) * randomChange;
                
                // Calculate new value with business hour pattern and clamping
                value = Math.max(baseline * 0.7, Math.min(max, value + correlatedChange * hourFactor));
                
                data.push(Math.round(value));
            }
            
            return data;
        }
        
        function createChart(elementId, label, color, data, labels) {
            const canvas = document.getElementById(elementId);
            if (!canvas) {
                console.error(`Chart canvas element not found: ${elementId}`);
                return null;
            }
            
            try {
                const ctx = canvas.getContext('2d');
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                        labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                            backgroundColor: color + '20', // Very transparent fill
                            borderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            tension: 0.4,
                            fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    font: {
                                        size: 10
                    }
                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: true,
                                    maxTicksLimit: 8,
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.7)',
                                titleFont: {
                                    size: 12
                                },
                                bodyFont: {
                                    size: 12
                                },
                                padding: 10,
                                caretSize: 6,
                                displayColors: false
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        elements: {
                            point: {
                                radius: 0,
                                hitRadius: 10,
                                hoverRadius: 5
                            }
                        }
                    }
                });
            } catch (error) {
                console.error(`Error creating chart ${elementId}:`, error);
                return null;
            }
        }
        
        function updateChartStatistics() {
            try {
                // Calculate and display statistics for each chart
                if (apiRequestsChart && apiRequestsChart.data && apiRequestsChart.data.datasets[0].data) {
                    const apiData = apiRequestsChart.data.datasets[0].data;
                    const apiAvgElement = document.getElementById('api-avg');
                    const apiPeakElement = document.getElementById('api-peak');
                    
                    if (apiAvgElement) {
                        apiAvgElement.textContent = Math.round(apiData.reduce((a, b) => a + b, 0) / apiData.length);
                    }
                    
                    if (apiPeakElement) {
                        apiPeakElement.textContent = Math.max(...apiData);
                    }
                }
                
                if (predictionRequestsChart && predictionRequestsChart.data && predictionRequestsChart.data.datasets[0].data) {
                    const predData = predictionRequestsChart.data.datasets[0].data;
                    const predAvgElement = document.getElementById('pred-avg');
                    const predPeakElement = document.getElementById('pred-peak');
                    
                    if (predAvgElement) {
                        predAvgElement.textContent = Math.round(predData.reduce((a, b) => a + b, 0) / predData.length);
                    }
                    
                    if (predPeakElement) {
                        predPeakElement.textContent = Math.max(...predData);
                    }
                }
                
                if (userSessionsChart && userSessionsChart.data && userSessionsChart.data.datasets[0].data) {
                    const sessionData = userSessionsChart.data.datasets[0].data;
                    const sessionAvgElement = document.getElementById('session-avg');
                    const sessionPeakElement = document.getElementById('session-peak');
                    
                    if (sessionAvgElement) {
                        sessionAvgElement.textContent = Math.round(sessionData.reduce((a, b) => a + b, 0) / sessionData.length);
                    }
                    
                    if (sessionPeakElement) {
                        sessionPeakElement.textContent = Math.max(...sessionData);
                    }
                }
            } catch (error) {
                console.error("Error updating chart statistics:", error);
            }
        }
        
        function updateCharts() {
            // Update each chart with new data
            if (apiRequestsChart) {
                try {
                    apiRequestsChart.data.datasets[0].data = generateRealisticData(40, 80, 24);
                    apiRequestsChart.update();
                } catch (error) {
                    console.error("Error updating API requests chart:", error);
                }
            }
            
            if (predictionRequestsChart) {
                try {
                    predictionRequestsChart.data.datasets[0].data = generateRealisticData(20, 60, 24, 0.7);
                    predictionRequestsChart.update();
                } catch (error) {
                    console.error("Error updating prediction requests chart:", error);
                }
            }
            
            if (userSessionsChart) {
                try {
                    userSessionsChart.data.datasets[0].data = generateRealisticData(15, 35, 24, 0.5);
                    userSessionsChart.update();
                } catch (error) {
                    console.error("Error updating user sessions chart:", error);
                }
            }
            
            // Update summary statistics after chart data is updated
            updateChartStatistics();
        }
        
        // Refresh data periodically
        setInterval(() => {
            loadSystemStatus();
            
            // Also update charts independently for a more dynamic UI
            updateCharts();
        }, 60000); // Refresh every minute
    </script>
</body>
</html>