{% extends "base.html" %}

{% block title %}Cross-Domain Correlation{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Cross-Domain Correlation Analysis</h4>
                </div>
                <div class="card-body">
                    <p class="lead">
                        Discover non-obvious relationships between seemingly unrelated data domains.
                        Cross-Domain Correlation Analysis identifies patterns and connections across different datasets,
                        revealing insights that would remain hidden when data is analyzed in isolation.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card dashboard-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Domain Selection</h5>
                </div>
                <div class="card-body">
                    <form id="correlation-form">
                        <div class="mb-3">
                            <label for="domain1" class="form-label">First Domain</label>
                            <select class="form-select" id="domain1">
                                <option value="weather">Weather</option>
                                <option value="economic">Economic</option>
                                <option value="transportation">Transportation</option>
                                <option value="social-media">Social Media</option>
                                <option value="health">Public Health</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="field1" class="form-label">First Domain Metric</label>
                            <select class="form-select" id="field1">
                                <option value="loading">Select a domain first...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="domain2" class="form-label">Second Domain</label>
                            <select class="form-select" id="domain2">
                                <option value="weather">Weather</option>
                                <option value="economic" selected>Economic</option>
                                <option value="transportation">Transportation</option>
                                <option value="social-media">Social Media</option>
                                <option value="health">Public Health</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="field2" class="form-label">Second Domain Metric</label>
                            <select class="form-select" id="field2">
                                <option value="loading">Select a domain first...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="time-range" class="form-label">Time Range</label>
                            <select class="form-select" id="time-range">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d" selected>Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="1y">Last Year</option>
                                <option value="all">All Available Data</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-graph-up me-2"></i> Analyze Correlation
                        </button>
                    </form>
                </div>
            </div>

            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">Top Correlations</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="top-correlations">
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Temperature ↔️ Energy Demand</h6>
                                <span class="badge bg-primary rounded-pill">0.89</span>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 89%"></div>
                            </div>
                            <p class="mb-1 small text-muted">Weather ↔️ Energy</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Social Sentiment ↔️ Stock Prices</h6>
                                <span class="badge bg-primary rounded-pill">0.72</span>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 72%"></div>
                            </div>
                            <p class="mb-1 small text-muted">Social Media ↔️ Economic</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Traffic Density ↔️ Retail Sales</h6>
                                <span class="badge bg-primary rounded-pill">0.68</span>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 68%"></div>
                            </div>
                            <p class="mb-1 small text-muted">Transportation ↔️ Economic</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Precipitation ↔️ Public Transit Usage</h6>
                                <span class="badge bg-primary rounded-pill">0.65</span>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 65%"></div>
                            </div>
                            <p class="mb-1 small text-muted">Weather ↔️ Transportation</p>
                        </div>
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">Social Events ↔️ Respiratory Cases</h6>
                                <span class="badge bg-primary rounded-pill">0.61</span>
                            </div>
                            <div class="progress mt-1" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 61%"></div>
                            </div>
                            <p class="mb-1 small text-muted">Social Media ↔️ Health</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card dashboard-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Correlation Results</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="correlation-heatmap" id="correlationHeatmap" style="height: 400px;"></div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5 class="card-title">Primary Analysis</h5>
                                    <h2 class="display-4 text-primary" id="correlation-value">0.78</h2>
                                    <p class="card-text">Strong positive correlation</p>
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 78%"></div>
                                    </div>
                                    <p class="mb-0">Temperature (Weather)</p>
                                    <p class="mb-3">Energy Demand (Energy)</p>
                                    <p class="card-text text-muted">Based on 90 days of data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="chart-container">
                                <canvas id="scatterPlot" height="300"></canvas>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle-fill me-2"></i> The scatter plot shows the relationship between the selected variables with each point representing a day in the selected time period. The trend line indicates the direction and strength of the correlation.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">Network Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="correlation-network" id="correlationNetwork" style="height: 400px;"></div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle-fill me-2"></i> This network graph shows relationships between multiple domains. Thicker lines indicate stronger correlations, and node size represents the number of significant correlations.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Domain fields mapping
        const domainFields = {
            'weather': ['temperature', 'precipitation', 'humidity', 'wind_speed', 'pressure'],
            'economic': ['market_index', 'consumer_confidence', 'interest_rate', 'unemployment_rate', 'inflation'],
            'transportation': ['traffic_volume', 'transit_ridership', 'average_speed', 'congestion_level', 'accident_count'],
            'social-media': ['sentiment', 'trending_topics', 'engagement_rate', 'mention_volume', 'hashtag_usage'],
            'health': ['flu_cases', 'hospital_admissions', 'air_quality_index', 'vaccination_rate', 'respiratory_cases']
        };
        
        // Update field options based on domain selection
        function updateFieldOptions(domainSelect, fieldSelect) {
            const domain = domainSelect.value;
            const fields = domainFields[domain] || [];
            
            // Clear existing options
            fieldSelect.innerHTML = '';
            
            // Add new options
            fields.forEach(field => {
                const option = document.createElement('option');
                option.value = field;
                option.textContent = field.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                fieldSelect.appendChild(option);
            });
        }
        
        // Initialize field selectors
        const domain1Select = document.getElementById('domain1');
        const field1Select = document.getElementById('field1');
        const domain2Select = document.getElementById('domain2');
        const field2Select = document.getElementById('field2');
        
        domain1Select.addEventListener('change', () => updateFieldOptions(domain1Select, field1Select));
        domain2Select.addEventListener('change', () => updateFieldOptions(domain2Select, field2Select));
        
        // Initialize with default values
        updateFieldOptions(domain1Select, field1Select);
        updateFieldOptions(domain2Select, field2Select);
        
        // Handle correlation analysis form submission
        document.getElementById('correlation-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // Show loading state
            document.getElementById('correlationHeatmap').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            document.getElementById('scatterPlot').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            document.getElementById('correlationNetwork').innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // Disable the submit button to prevent multiple submissions
            const submitButton = document.querySelector('#correlation-form button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';

            // Get form data
            const domain1 = domain1Select.value;
            const field1 = field1Select.value;
            const domain2 = domain2Select.value;
            const field2 = field2Select.value;
            const timeRange = document.getElementById('time-range').value;

            // Call the API endpoint to analyze correlation
            fetch('/api/correlation/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    domain1: domain1,
                    field1: field1,
                    domain2: domain2,
                    field2: field2,
                    time_range: timeRange
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API response:', data);

                // Update correlation value display
                document.getElementById('correlation-value').textContent = data.correlation_value.toFixed(2);

                // Update strength description
                const strengthText = document.querySelector('.card-text');
                if (strengthText) {
                    const absCorr = Math.abs(data.correlation_value);
                    let strength = "No";
                    if (absCorr > 0.8) strength = "Very strong";
                    else if (absCorr > 0.6) strength = "Strong";
                    else if (absCorr > 0.4) strength = "Moderate";
                    else if (absCorr > 0.2) strength = "Weak";
                    else strength = "Very weak";

                    const direction = data.correlation_value > 0 ? "positive" : "negative";
                    strengthText.textContent = `${strength} ${direction} correlation`;
                }

                // Update domain/field labels in the analysis card
                const domain1Label = document.querySelector('.card-body p.mb-0');
                const domain2Label = document.querySelector('.card-body p.mb-3');
                if (domain1Label && domain2Label) {
                    domain1Label.textContent = `${field1Select.options[field1Select.selectedIndex].text} (${domain1Select.options[domain1Select.selectedIndex].text})`;
                    domain2Label.textContent = `${field2Select.options[field2Select.selectedIndex].text} (${domain2Select.options[domain2Select.selectedIndex].text})`;
                }

                // Update visualizations with the returned data
                createHeatmap(data.matrix, data.labels);
                createScatterPlot(
                    data.scatter_data.x,
                    data.scatter_data.y,
                    field1Select.options[field1Select.selectedIndex].text,
                    field2Select.options[field2Select.selectedIndex].text
                );
                createNetworkGraph(data.network.nodes, data.network.links);

                // Update time range in description
                const timeDesc = document.querySelector('.card-text.text-muted');
                if (timeDesc) {
                    let timeText = "30 days";
                    if (timeRange === "7d") timeText = "7 days";
                    else if (timeRange === "90d") timeText = "90 days";
                    else if (timeRange === "1y") timeText = "1 year";
                    else if (timeRange === "all") timeText = "all available data";

                    timeDesc.textContent = `Based on ${timeText} of data`;

                    // Update the progress bar width to reflect correlation strength
                    const progressBar = document.querySelector('.progress-bar');
                    if (progressBar) {
                        const width = Math.abs(data.correlation_value * 100);
                        progressBar.style.width = `${width}%`;
                    }
                }

                // Update the Top Correlations section
                updateTopCorrelations(data);
            })
            .catch(error => {
                console.error('Error analyzing correlation:', error);
                showErrorMessage('Error analyzing correlation. Please try again.');

                // Fallback to simulated data if API fails
                const correlationValue = generateCorrelationValue(domain1, field1, domain2, field2);
                document.getElementById('correlation-value').textContent = correlationValue.toFixed(2);

                const matrix = generateMatrixData(domain1, field1, domain2, field2);
                const labels = generateMatrixLabels(domain1, field1, domain2, field2);
                const scatterData = generateScatterData(correlationValue);
                const networkData = generateNetworkData(domain1, domain2);

                createHeatmap(matrix, labels);
                createScatterPlot(
                    scatterData.x,
                    scatterData.y,
                    field1Select.options[field1Select.selectedIndex].text,
                    field2Select.options[field2Select.selectedIndex].text
                );
                createNetworkGraph(networkData.nodes, networkData.links);
            })
            .finally(() => {
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Analyze Correlation';
            });
        });
        
        // Generate a deterministic correlation value based on inputs
        function generateCorrelationValue(domain1, field1, domain2, field2) {
            // Create a hash from the inputs to ensure consistency
            const str = `${domain1}-${field1}-${domain2}-${field2}`;
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }
            
            // Get a value between 0 and 1
            const normalizedHash = Math.abs(hash % 1000) / 1000;
            
            // For more realistic correlations, transform to a value between -0.9 and 0.9
            // with higher probability of stronger correlations
            let correlation;
            if (normalizedHash < 0.4) {
                // 40% chance of strong positive correlation (0.6 to 0.9)
                correlation = 0.6 + (normalizedHash / 0.4 * 0.3);
            } else if (normalizedHash < 0.7) {
                // 30% chance of moderate positive correlation (0.3 to 0.6)
                correlation = 0.3 + ((normalizedHash - 0.4) / 0.3 * 0.3);
            } else if (normalizedHash < 0.85) {
                // 15% chance of weak positive correlation (0 to 0.3)
                correlation = ((normalizedHash - 0.7) / 0.15 * 0.3);
            } else if (normalizedHash < 0.95) {
                // 10% chance of weak to moderate negative correlation (-0.5 to 0)
                correlation = -0.5 + ((normalizedHash - 0.85) / 0.1 * 0.5);
            } else {
                // 5% chance of strong negative correlation (-0.9 to -0.5)
                correlation = -0.9 + ((normalizedHash - 0.95) / 0.05 * 0.4);
            }
            
            return correlation;
        }
        
        // Generate matrix data
        function generateMatrixData(domain1, field1, domain2, field2) {
            // Create matrix size (consistent with labels)
            const size = 10; // 5 fields from each domain
            const matrix = Array(size).fill().map(() => Array(size).fill(0));
            
            // Set diagonal to 1.0 (self-correlation)
            for (let i = 0; i < size; i++) {
                matrix[i][i] = 1.0;
            }
            
            // Fill with simulated correlations
            for (let i = 0; i < size; i++) {
                for (let j = i+1; j < size; j++) {
                    // Generate a deterministic value based on positions
                    const combined = `${domain1}-${field1}-${domain2}-${field2}-${i}-${j}`;
                    let hash = 0;
                    for (let k = 0; k < combined.length; k++) {
                        hash = ((hash << 5) - hash) + combined.charCodeAt(k);
                        hash |= 0;
                    }
                    const normalizedHash = Math.abs(hash % 1000) / 1000;
                    
                    // Higher correlation for related fields
                    let corr;
                    if ((i < 5 && j < 5) || (i >= 5 && j >= 5)) {
                        // Same domain, higher correlation
                        corr = 0.5 + (normalizedHash * 0.5);
                    } else {
                        // Different domains
                        corr = (normalizedHash * 1.8) - 0.9;
                    }
                    
                    // Clamp between -1 and 1
                    corr = Math.max(-0.99, Math.min(0.99, corr));
                    
                    // Correlation matrix is symmetric
                    matrix[i][j] = corr;
                    matrix[j][i] = corr;
                }
            }
            
            return matrix;
        }
        
        // Generate matrix labels
        function generateMatrixLabels(domain1, field1, domain2, field2) {
            // Create related domain fields
            const domain1Fields = [
                `${field1} Daily`, 
                field1.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                `${field1} Max`, 
                `${field1} Min`, 
                `${field1} Trend`
            ];
            
            const domain2Fields = [
                `${field2} Daily`,
                field2.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                `${field2} Max`,
                `${field2} Min`,
                `${field2} Trend`
            ];
            
            // Combine labels
            return domain1Fields.concat(domain2Fields);
        }
        
        // Generate scatter data
        function generateScatterData(correlation) {
            const points = 30;
            const xData = Array.from({length: points}, (_, i) => 10 + ((90 / points) * i));
            
            // Generate y values with noise but maintaining correlation
            const yData = xData.map(x => {
                const perfect = correlation * x;
                const noise = ((Math.random() * 2) - 1) * 15;
                return perfect + noise;
            });
            
            return {
                x: xData,
                y: yData
            };
        }
        
        // Generate network data
        function generateNetworkData(domain1, domain2) {
            // Define domains to include
            const domains = ['Weather', 'Energy', 'Economic', 'Transportation', 'Social Media', 'Health'];
            
            // Convert input domains to proper format
            const domain1Name = domain1.replace('-', ' ').replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
            const domain2Name = domain2.replace('-', ' ').replace(/(^\w{1})|(\s+\w{1})/g, letter => letter.toUpperCase());
            
            // Make a copy of domains to avoid modifying the original
            const nodeLabels = [...domains];
            
            // Ensure our domains are in the list
            if (!nodeLabels.includes(domain1Name)) {
                nodeLabels[0] = domain1Name;
            }
            if (!nodeLabels.includes(domain2Name)) {
                nodeLabels[1] = domain2Name;
            }
            
            // Create nodes
            const nodes = nodeLabels.map((domain, i) => ({
                id: domain,
                group: i+1
            }));
            
            // Create links
            const links = [];
            
            // Add link between selected domains with strong correlation
            const mainCorrelation = generateCorrelationValue(domain1, '', domain2, '');
            links.push({
                source: domain1Name,
                target: domain2Name,
                value: Math.abs(mainCorrelation)
            });
            
            // Add additional connections for each domain
            nodeLabels.forEach((source, i) => {
                // Each domain should connect to at least one other
                const connectCount = 1 + Math.floor((Math.abs(hash(source)) % 3));
                const connected = source === domain1Name ? [domain2Name] : [];
                
                for (let j = 0; j < nodeLabels.length; j++) {
                    const target = nodeLabels[j];
                    
                    if (target !== source && !connected.includes(target) && connected.length < connectCount) {
                        // Generate a correlation strength
                        const seed = hash(`${source}-${target}`);
                        const random = Math.abs(seed % 1000) / 1000;
                        const value = 0.3 + (random * 0.6);
                        
                        links.push({
                            source: source,
                            target: target,
                            value: value
                        });
                        connected.push(target);
                    }
                }
            });
            
            return {
                nodes: nodes,
                links: links
            };
        }
        
        // Simple hash function for strings
        function hash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return hash;
        }
        
        // Correlation heatmap
        function createHeatmap(matrix, labels) {
            const heatmapLabels = labels || ['Temperature', 'Energy Demand', 'Market Index', 'Consumer Confidence', 'Social Sentiment'];
            
            Plotly.newPlot('correlationHeatmap', [{
                z: matrix,
                x: heatmapLabels,
                y: heatmapLabels,
                type: 'heatmap',
                colorscale: 'Blues',
                showscale: true,
                zmin: 0,
                zmax: 1
            }], {
                title: 'Cross-Domain Correlation Heatmap',
                margin: { t: 50, r: 20, b: 80, l: 80 }
            });
        }
        
        // Create scatter plot
        function createScatterPlot(xData, yData, xLabel, yLabel) {
            const ctx = document.getElementById('scatterPlot').getContext('2d');
            
            // Generate simulated data if not provided
            const points = 30;
            const baseX = xData || Array.from({length: points}, (_, i) => 50 + i);
            const baseY = yData || baseX.map(x => 0.78 * x + (Math.random() * 20 - 10));
            
            // Clear existing chart if present
            if (window.scatterChart) {
                window.scatterChart.destroy();
            }
            
            window.scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${xLabel || 'Temperature'} vs ${yLabel || 'Energy Demand'}`,
                        data: baseX.map((x, i) => ({x, y: baseY[i]})),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xLabel || 'Temperature (°F)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yLabel || 'Energy Demand (MW)'
                            }
                        }
                    }
                }
            });
        }
        
        // Create network graph
        function createNetworkGraph(nodes, links) {
            // Sample data for network graph if not provided
            const networkNodes = nodes || [
                {id: 'Weather', group: 1},
                {id: 'Energy', group: 2},
                {id: 'Economic', group: 3},
                {id: 'Transportation', group: 4},
                {id: 'Social Media', group: 5},
                {id: 'Health', group: 6}
            ];
            
            const networkLinks = links || [
                {source: 'Weather', target: 'Energy', value: 0.89},
                {source: 'Weather', target: 'Transportation', value: 0.65},
                {source: 'Weather', target: 'Health', value: 0.58},
                {source: 'Energy', target: 'Economic', value: 0.72},
                {source: 'Economic', target: 'Social Media', value: 0.68},
                {source: 'Transportation', target: 'Economic', value: 0.61},
                {source: 'Social Media', target: 'Health', value: 0.51},
                {source: 'Health', target: 'Transportation', value: 0.47}
            ];
            
            // Set up SVG for D3
            const width = document.getElementById('correlationNetwork').clientWidth;
            const height = 400;
            
            // Clear previous graph
            d3.select('#correlationNetwork').html('');
            
            const svg = d3.select('#correlationNetwork')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
                
            // Set up the simulation
            const simulation = d3.forceSimulation(networkNodes)
                .force('link', d3.forceLink(networkLinks).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
                
            // Add links
            const link = svg.append('g')
                .selectAll('line')
                .data(networkLinks)
                .enter().append('line')
                .attr('stroke-width', d => d.value * 5)
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6);
                
            // Add nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(networkNodes)
                .enter().append('circle')
                .attr('r', 15)
                .attr('fill', d => d3.schemeCategory10[d.group % 10])
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
                    
            // Add node labels
            const text = svg.append('g')
                .selectAll('text')
                .data(networkNodes)
                .enter().append('text')
                .attr('dy', '.35em')
                .style('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('font-weight', 'bold')
                .text(d => d.id);
                
            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                    
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                    
                text
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
        
        /**
         * Update top correlations list based on API data
         */
        function updateTopCorrelations(data) {
            const topCorrelationsList = document.getElementById('top-correlations');
            if (!topCorrelationsList) return;

            // Clear existing items
            topCorrelationsList.innerHTML = '';

            // Create a new correlation item based on the current analysis
            const newCorrelationItem = document.createElement('div');
            newCorrelationItem.className = 'list-group-item';

            const domain1Name = domain1Select.options[domain1Select.selectedIndex].text;
            const field1Name = field1Select.options[field1Select.selectedIndex].text;
            const domain2Name = domain2Select.options[domain2Select.selectedIndex].text;
            const field2Name = field2Select.options[field2Select.selectedIndex].text;

            newCorrelationItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${field1Name} ↔️ ${field2Name}</h6>
                    <span class="badge bg-primary rounded-pill">${Math.abs(data.correlation_value).toFixed(2)}</span>
                </div>
                <div class="progress mt-1" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: ${Math.abs(data.correlation_value) * 100}%"></div>
                </div>
                <p class="mb-1 small text-muted">${domain1Name} ↔️ ${domain2Name}</p>
            `;

            // Add to top of the list
            topCorrelationsList.insertBefore(newCorrelationItem, topCorrelationsList.firstChild);

            // Generate a few more correlations to fill the list
            const domains = ['Weather', 'Transportation', 'Economic', 'Social Media', 'Health'];
            const fields = {
                'Weather': ['Temperature', 'Humidity', 'Precipitation', 'Wind Speed'],
                'Transportation': ['Traffic Congestion', 'Average Speed', 'Accident Rate', 'Public Transit Usage'],
                'Economic': ['Market Index', 'Consumer Confidence', 'Interest Rate', 'Unemployment Rate'],
                'Social Media': ['Sentiment', 'Engagement', 'Trending Topics', 'Mention Volume'],
                'Health': ['Hospital Admissions', 'Flu Cases', 'Air Quality Index', 'Vaccination Rate']
            };

            // Add 4 more correlations (for a total of 5)
            for (let i = 0; i < 4; i++) {
                const d1 = domains[Math.floor(Math.random() * domains.length)];
                const f1 = fields[d1][Math.floor(Math.random() * fields[d1].length)];

                let d2 = domains[Math.floor(Math.random() * domains.length)];
                while (d2 === d1) {
                    d2 = domains[Math.floor(Math.random() * domains.length)];
                }
                const f2 = fields[d2][Math.floor(Math.random() * fields[d2].length)];

                // Generate a correlation value between 0.5 and 0.9
                const correlationValue = 0.5 + (Math.random() * 0.4);

                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${f1} ↔️ ${f2}</h6>
                        <span class="badge bg-primary rounded-pill">${correlationValue.toFixed(2)}</span>
                    </div>
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar" role="progressbar" style="width: ${correlationValue * 100}%"></div>
                    </div>
                    <p class="mb-1 small text-muted">${d1} ↔️ ${d2}</p>
                `;

                topCorrelationsList.appendChild(item);
            }
        }

        /**
         * Show an error message
         */
        function showErrorMessage(message) {
            // Create an alert element
            const alertElement = document.createElement('div');
            alertElement.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertElement.setAttribute('role', 'alert');
            alertElement.innerHTML = `
                <strong>Error!</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Insert at the top of the results area
            const resultsCards = document.querySelectorAll('.card-header');
            let resultsCard = null;

            // Find the correlation results card
            for (const card of resultsCards) {
                if (card.textContent.includes('Correlation Results')) {
                    resultsCard = card.closest('.card');
                    break;
                }
            }

            if (resultsCard) {
                resultsCard.parentNode.insertBefore(alertElement, resultsCard);
            } else {
                // Fallback if we can't find the results card
                const firstCard = document.querySelector('.card');
                if (firstCard) {
                    firstCard.parentNode.insertBefore(alertElement, firstCard);
                }
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertElement.classList.remove('show');
                setTimeout(() => alertElement.remove(), 500);
            }, 5000);
        }

        // Function to provide initial display on page load
        function initialDisplay() {
            // Add helpful tooltips to form elements
            const domainSelects = document.querySelectorAll('select.form-select');
            domainSelects.forEach(select => {
                select.setAttribute('data-bs-toggle', 'tooltip');
                select.setAttribute('data-bs-placement', 'right');
                select.setAttribute('title', 'Select a domain to analyze');
            });

            // Add a helpful message above the form
            const formCard = document.querySelector('#correlation-form').closest('.card-body');
            if (formCard) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'alert alert-info mb-3';
                helpDiv.innerHTML = `
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>How to use:</strong> Select two domains and metrics to analyze,
                    then click "Analyze Correlation" to see their relationship.
                `;
                formCard.insertBefore(helpDiv, formCard.firstChild);
            }

            // Initialize the tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Initial display
        initialDisplay();
    });
</script>
{% endblock %} 